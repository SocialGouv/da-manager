name: Claude Review Check

on:
  deployment_status:

jobs:
  notify:
    # Déploiements réussis sur des branches Claude uniquement.
    # Pas de filtre sur le nom d'environnement : les workflows review
    # et review-auto couvrent des cas différents mais ne sont jamais
    # simultanés sur une même PR. Le health check confirme que
    # l'app est réellement prête.
    if: >
      github.event.deployment_status.state == 'success' &&
      startsWith(github.event.deployment.ref, 'feat/claude-')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.deployment.ref }}

      - name: Find associated PR
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER=$(gh pr list \
            --head "${{ github.event.deployment.ref }}" \
            --json number --jq '.[0].number')
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Check iteration count (max 3)
        if: steps.pr.outputs.number != ''
        id: count
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COUNT=$(gh api \
            "repos/${{ github.repository }}/issues/${{ steps.pr.outputs.number }}/comments" \
            --jq '[.[] | select(.body | contains("@claude")) | select(.body | contains("environnement review est déployé"))] | length')
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          if [ "$COUNT" -ge 3 ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Max review iterations (3) reached. Skipping."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Review iteration $((COUNT + 1))/3"
          fi

      - name: Compute review URL
        if: steps.pr.outputs.number != '' && steps.count.outputs.skip != 'true'
        id: env
        uses: socialgouv/kontinuous/.github/actions/env@v1

      - name: Wait for app to be ready
        if: steps.pr.outputs.number != '' && steps.count.outputs.skip != 'true'
        id: health
        env:
          REVIEW_URL: https://${{ steps.env.outputs.subdomain }}.ovh.fabrique.social.gouv.fr
        run: |
          echo "review_url=$REVIEW_URL" >> "$GITHUB_OUTPUT"
          for i in $(seq 1 8); do
            HTTP_CODE=$(curl -sL -o /dev/null -w "%{http_code}" "$REVIEW_URL/api/healthz" 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "ready=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "Health check $HTTP_CODE (attempt $i/8). Waiting 15s..."
            sleep 15
          done
          echo "ready=false" >> "$GITHUB_OUTPUT"

      - name: Post @claude comment
        if: >
          steps.pr.outputs.number != '' &&
          steps.count.outputs.skip != 'true' &&
          steps.health.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          REVIEW_URL: ${{ steps.health.outputs.review_url }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          ITERATION: ${{ steps.count.outputs.count }}
        run: |
          ITER=$((ITERATION + 1))
          gh pr comment "$PR_NUMBER" --body "@claude L'environnement review est déployé (vérification $ITER/3) : $REVIEW_URL

          ## Critères d'acceptance

          1. **Health check** : \`GET $REVIEW_URL/api/healthz\` retourne HTTP 200
          2. **Page d'accueil (sans auth)** : \`GET $REVIEW_URL/\` retourne HTTP 200, contient les classes DSFR (\`fr-header\`, \`fr-footer\`)
          3. **Pages authentifiées** : après dev login, les pages \`/view/\` et \`/da/\` répondent sans erreur 500

          ## Méthodologie de test

          **Étape 1 — Vérifications sans auth :**
          \`\`\`bash
          curl -sL -o /dev/null -w '%{http_code}' $REVIEW_URL/api/healthz
          curl -sL $REVIEW_URL/ | head -100
          \`\`\`

          **Étape 2 — Dev login via curl :**
          \`\`\`bash
          CSRF=\$(curl -sL $REVIEW_URL/api/auth/csrf | jq -r '.csrfToken')
          curl -sL -c cookies.txt -X POST $REVIEW_URL/api/auth/callback/dev-login \\
            -d \"csrfToken=\$CSRF&email=admin@test.fr&name=Admin+Dev\"
          \`\`\`

          **Étape 3 — Vérifications avec auth :**
          \`\`\`bash
          curl -sL -b cookies.txt $REVIEW_URL/ | head -100
          curl -sL -b cookies.txt -o /dev/null -w '%{http_code}' $REVIEW_URL/view/1
          \`\`\`

          **Étape 4 — Résultat :**
          - Si tout est OK : poste un commentaire confirmant que la vérification a réussi
          - Si un problème est détecté : corrige le code source et pousse les modifications"
