name: Claude Review Check

on:
  deployment_status:

jobs:
  notify:
    # Déploiements réussis sur des branches Claude uniquement.
    # Pas de filtre sur le nom d'environnement : les workflows review
    # et review-auto couvrent des cas différents mais ne sont jamais
    # simultanés sur une même PR. Le health check confirme que
    # l'app est réellement prête.
    if: >
      github.event.deployment_status.state == 'success' &&
      startsWith(github.event.deployment.ref, 'feat/claude-')
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.deployment.ref }}

      - name: Find associated PR and issue
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_JSON=$(gh pr list \
            --head "${{ github.event.deployment.ref }}" \
            --json number,body --jq '.[0]')
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number')
          ISSUE_NUMBER=$(echo "$PR_JSON" | jq -r '.body' | grep -oP '(?i)closes?\s+#\K\d+' | head -1)
          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "issue=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Check iteration count (max 3)
        if: steps.pr.outputs.number != ''
        id: count
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COUNT=$(gh api \
            "repos/${{ github.repository }}/issues/${{ steps.pr.outputs.number }}/comments" \
            --jq '[.[] | select(.body | contains("@claude")) | select(.body | contains("environnement review est déployé"))] | length')
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"
          if [ "$COUNT" -ge 3 ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Max review iterations (3) reached. Skipping."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Review iteration $((COUNT + 1))/3"
          fi

      - name: Compute review URL
        if: steps.pr.outputs.number != '' && steps.count.outputs.skip != 'true'
        id: env
        uses: socialgouv/kontinuous/.github/actions/env@v1

      - name: Wait for app to be ready
        if: steps.pr.outputs.number != '' && steps.count.outputs.skip != 'true'
        id: health
        env:
          REVIEW_URL: https://${{ steps.env.outputs.subdomain }}.ovh.fabrique.social.gouv.fr
        run: |
          echo "review_url=$REVIEW_URL" >> "$GITHUB_OUTPUT"
          for i in $(seq 1 8); do
            HTTP_CODE=$(curl -sL -o /dev/null -w "%{http_code}" "$REVIEW_URL/api/healthz" 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "ready=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "Health check $HTTP_CODE (attempt $i/8). Waiting 15s..."
            sleep 15
          done
          echo "ready=false" >> "$GITHUB_OUTPUT"

      - name: Get token
        if: >
          steps.pr.outputs.number != '' &&
          steps.count.outputs.skip != 'true' &&
          steps.health.outputs.ready == 'true'
        id: app-token
        uses: SocialGouv/token-bureau@main
        with:
          token-bureau-url: https://token-bureau.fabrique.social.gouv.fr
          audience: socialgouv

      - name: Post @claude comment
        if: >
          steps.pr.outputs.number != '' &&
          steps.count.outputs.skip != 'true' &&
          steps.health.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          REVIEW_URL: ${{ steps.health.outputs.review_url }}
          PR_NUMBER: ${{ steps.pr.outputs.number }}
          ISSUE_NUMBER: ${{ steps.pr.outputs.issue }}
          ITERATION: ${{ steps.count.outputs.count }}
        run: |
          ITER=$((ITERATION + 1))
          ISSUE_REF=""
          if [ -n "$ISSUE_NUMBER" ]; then
            ISSUE_REF=" (issue #$ISSUE_NUMBER)"
          fi
          gh pr comment "$PR_NUMBER" --body "@claude Environnement review déployé (vérification $ITER/3) : $REVIEW_URL — Vérifie que l'application fonctionne et que les changements$ISSUE_REF sont effectifs. Si tout est OK, marque la PR ready for review."
